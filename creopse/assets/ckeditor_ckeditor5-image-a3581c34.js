import{C as b,P as h,i as I}from"./ckeditor_ckeditor5-core-c8d003a2.js";import{f as R,R as Ce,K as ye,l as k,t as J,C as ve,a as Se,z as D,e as ke}from"./ckeditor_ckeditor5-utils-df07b536.js";import{O as _e,U as z,e as Ae,h as Be}from"./ckeditor_ckeditor5-engine-af85ebf5.js";import{t as Ue,i as xe,f as Te,W as Z,a as Ve,b as A,c as F}from"./ckeditor_ckeditor5-widget-96b25423.js";import{V as Re,f as ze,F as Oe,s as Ne,B as y,L as De,h as Fe,u as Le,v as Pe,C as Me,w as We,M as qe,c as Q,D as je,b as $e,S as He,a as Ge,N as L}from"./ckeditor_ckeditor5-ui-b7ac7aa2.js";import"./color-convert-eee2eef5.js";import"./vanilla-colorful-3f59310b.js";import{a as O}from"./ckeditor_ckeditor5-clipboard-a9aafe73.js";import{d as X,o as E}from"./lodash-es-a215867d.js";import{F as Ke,a as C}from"./ckeditor_ckeditor5-upload-bbe26b68.js";/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class Je extends b{refresh(){const i=this.editor.plugins.get("ImageUtils").getClosestSelectedImageElement(this.editor.model.document.selection);this.isEnabled=!!i,this.isEnabled&&i.hasAttribute("alt")?this.value=i.getAttribute("alt"):this.value=!1}execute(e){const t=this.editor,i=t.plugins.get("ImageUtils"),n=t.model,o=i.getClosestSelectedImageElement(n.document.selection);n.change(a=>{a.setAttribute("alt",e.newValue,o)})}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */function Ze(s){return s.createContainerElement("span",{class:"image-inline"},s.createEmptyElement("img"))}function P(s){return s.createContainerElement("figure",{class:"image"},[s.createEmptyElement("img"),s.createSlot("children")])}function Y(s,e){const t=s.plugins.get("ImageUtils"),i=s.plugins.has("ImageInlineEditing")&&s.plugins.has("ImageBlockEditing");return o=>t.isInlineImageView(o)?i&&(o.getStyle("display")=="block"||o.findAncestor(t.isBlockImageView)?"imageBlock":"imageInline")!==e?null:n(o):null;function n(o){const a={name:!0};return o.hasAttribute("src")&&(a.attributes=["src"]),a}}function N(s,e){const t=R(e.getSelectedBlocks());return!t||s.isObject(t)||t.isEmpty&&t.name!="listItem"?"imageBlock":"imageInline"}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class f extends h{static get pluginName(){return"ImageUtils"}isImage(e){return this.isInlineImage(e)||this.isBlockImage(e)}isInlineImageView(e){return!!e&&e.is("element","img")}isBlockImageView(e){return!!e&&e.is("element","figure")&&e.hasClass("image")}insertImage(e={},t=null,i=null){const n=this.editor,o=n.model,a=o.document.selection;i=ee(n,t||a,i),e={...Object.fromEntries(a.getAttributes()),...e};for(const l in e)o.schema.checkAttribute(i,l)||delete e[l];return o.change(l=>{const r=l.createElement(i,e);return o.insertObject(r,t,null,{setSelection:"on",findOptimalPosition:!t&&i!="imageInline"?"auto":void 0}),r.parent?r:null})}getClosestSelectedImageWidget(e){const t=e.getFirstPosition();if(!t)return null;const i=e.getSelectedElement();if(i&&this.isImageWidget(i))return i;let n=t.parent;for(;n;){if(n.is("element")&&this.isImageWidget(n))return n;n=n.parent}return null}getClosestSelectedImageElement(e){const t=e.getSelectedElement();return this.isImage(t)?t:e.getFirstPosition().findAncestor("imageBlock")}isImageAllowed(){const t=this.editor.model.document.selection;return Qe(this.editor,t)&&Xe(t)}toImageWidget(e,t,i){return t.setCustomProperty("image",!0,e),Ue(e,t,{label:()=>{const a=this.findViewImgElement(e).getAttribute("alt");return a?`${a} ${i}`:i}})}isImageWidget(e){return!!e.getCustomProperty("image")&&xe(e)}isBlockImage(e){return!!e&&e.is("element","imageBlock")}isInlineImage(e){return!!e&&e.is("element","imageInline")}findViewImgElement(e){if(this.isInlineImageView(e))return e;const t=this.editor.editing.view;for(const{item:i}of t.createRangeIn(e))if(this.isInlineImageView(i))return i}}function Qe(s,e){if(ee(s,e,null)=="imageBlock"){const i=Ye(e,s.model);if(s.model.schema.checkChild(i,"imageBlock"))return!0}else if(s.model.schema.checkChild(e.focus,"imageInline"))return!0;return!1}function Xe(s){return[...s.focus.getAncestors()].every(e=>!e.is("element","imageBlock"))}function Ye(s,e){const i=Te(s,e).start.parent;return i.isEmpty&&!i.is("element","$root")?i.parent:i}function ee(s,e,t){const i=s.model.schema,n=s.config.get("image.insert.type");return s.plugins.has("ImageBlockEditing")?s.plugins.has("ImageInlineEditing")?t||(n==="inline"?"imageInline":n==="block"?"imageBlock":e.is("selection")?N(i,e):i.checkChild(e,"imageInline")?"imageInline":"imageBlock"):"imageBlock":"imageInline"}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class et extends h{static get requires(){return[f]}static get pluginName(){return"ImageTextAlternativeEditing"}init(){this.editor.commands.add("imageTextAlternative",new Je(this.editor))}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class tt extends Re{constructor(e){super(e);const t=this.locale.t;this.focusTracker=new Ce,this.keystrokes=new ye,this.labeledInput=this._createLabeledInputView(),this.saveButtonView=this._createButton(t("Save"),I.check,"ck-button-save"),this.saveButtonView.type="submit",this.cancelButtonView=this._createButton(t("Cancel"),I.cancel,"ck-button-cancel","cancel"),this._focusables=new ze,this._focusCycler=new Oe({focusables:this._focusables,focusTracker:this.focusTracker,keystrokeHandler:this.keystrokes,actions:{focusPrevious:"shift + tab",focusNext:"tab"}}),this.setTemplate({tag:"form",attributes:{class:["ck","ck-text-alternative-form","ck-responsive-form"],tabindex:"-1"},children:[this.labeledInput,this.saveButtonView,this.cancelButtonView]})}render(){super.render(),this.keystrokes.listenTo(this.element),Ne({view:this}),[this.labeledInput,this.saveButtonView,this.cancelButtonView].forEach(e=>{this._focusables.add(e),this.focusTracker.add(e.element)})}destroy(){super.destroy(),this.focusTracker.destroy(),this.keystrokes.destroy()}_createButton(e,t,i,n){const o=new y(this.locale);return o.set({label:e,icon:t,tooltip:!0}),o.extendTemplate({attributes:{class:i}}),n&&o.delegate("execute").to(this,n),o}_createLabeledInputView(){const e=this.locale.t,t=new De(this.locale,Fe);return t.label=e("Text alternative"),t}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */function it(s){const e=s.plugins.get("ContextualBalloon");if(s.plugins.get("ImageUtils").getClosestSelectedImageWidget(s.editing.view.document.selection)){const i=te(s);e.updatePosition(i)}}function te(s){const e=s.editing.view,t=Le.defaultPositions,i=s.plugins.get("ImageUtils");return{target:e.domConverter.mapViewToDom(i.getClosestSelectedImageWidget(e.document.selection)),positions:[t.northArrowSouth,t.northArrowSouthWest,t.northArrowSouthEast,t.southArrowNorth,t.southArrowNorthWest,t.southArrowNorthEast,t.viewportStickyNorth]}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class nt extends h{static get requires(){return[Pe]}static get pluginName(){return"ImageTextAlternativeUI"}init(){this._createButton()}destroy(){super.destroy(),this._form&&this._form.destroy()}_createButton(){const e=this.editor,t=e.t;e.ui.componentFactory.add("imageTextAlternative",i=>{const n=e.commands.get("imageTextAlternative"),o=new y(i);return o.set({label:t("Change image text alternative"),icon:I.lowVision,tooltip:!0}),o.bind("isEnabled").to(n,"isEnabled"),o.bind("isOn").to(n,"value",a=>!!a),this.listenTo(o,"execute",()=>{this._showForm()}),o})}_createForm(){const e=this.editor,i=e.editing.view.document,n=e.plugins.get("ImageUtils");this._balloon=this.editor.plugins.get("ContextualBalloon"),this._form=new(Me(tt))(e.locale),this._form.render(),this.listenTo(this._form,"submit",()=>{e.execute("imageTextAlternative",{newValue:this._form.labeledInput.fieldView.element.value}),this._hideForm(!0)}),this.listenTo(this._form,"cancel",()=>{this._hideForm(!0)}),this._form.keystrokes.set("Esc",(o,a)=>{this._hideForm(!0),a()}),this.listenTo(e.ui,"update",()=>{n.getClosestSelectedImageWidget(i.selection)?this._isVisible&&it(e):this._hideForm(!0)}),We({emitter:this._form,activator:()=>this._isVisible,contextElements:()=>[this._balloon.view.element],callback:()=>this._hideForm()})}_showForm(){if(this._isVisible)return;this._form||this._createForm();const e=this.editor,t=e.commands.get("imageTextAlternative"),i=this._form.labeledInput;this._form.disableCssTransitions(),this._isInBalloon||this._balloon.add({view:this._form,position:te(e)}),i.fieldView.value=i.fieldView.element.value=t.value||"",this._form.labeledInput.fieldView.select(),this._form.enableCssTransitions()}_hideForm(e=!1){this._isInBalloon&&(this._form.focusTracker.isFocused&&this._form.saveButtonView.focus(),this._balloon.remove(this._form),e&&this.editor.editing.view.focus())}get _isVisible(){return!!this._balloon&&this._balloon.visibleView===this._form}get _isInBalloon(){return!!this._balloon&&this._balloon.hasView(this._form)}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class ie extends h{static get requires(){return[et,nt]}static get pluginName(){return"ImageTextAlternative"}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */function st(s){const e=(t,i,n)=>{if(!n.consumable.test(i.viewItem,{name:!0,classes:"image"}))return;const o=s.findViewImgElement(i.viewItem);if(!o||!n.consumable.test(o,{name:!0}))return;n.consumable.consume(i.viewItem,{name:!0,classes:"image"});const a=n.convertItem(o,i.modelCursor),l=R(a.modelRange.getItems());if(!l){n.consumable.revert(i.viewItem,{name:!0,classes:"image"});return}n.convertChildren(i.viewItem,l),n.updateConversionResult(l,i)};return t=>{t.on("element:figure",e)}}function ne(s,e){const t=(i,n,o)=>{if(!o.consumable.consume(n.item,i.name))return;const a=o.writer,l=o.mapper.toViewElement(n.item),r=s.findViewImgElement(l);if(n.attributeNewValue===null){const m=n.attributeOldValue;m&&m.data&&(a.removeAttribute("srcset",r),a.removeAttribute("sizes",r),m.width&&a.removeAttribute("width",r))}else{const m=n.attributeNewValue;m&&m.data&&(a.setAttribute("srcset",m.data,r),a.setAttribute("sizes","100vw",r),m.width&&a.setAttribute("width",m.width,r))}};return i=>{i.on(`attribute:srcset:${e}`,t)}}function _(s,e,t){const i=(n,o,a)=>{if(!a.consumable.consume(o.item,n.name))return;const l=a.writer,r=a.mapper.toViewElement(o.item),m=s.findViewImgElement(r);l.setAttribute(o.attributeKey,o.attributeNewValue||"",m)};return n=>{n.on(`attribute:${t}:${e}`,i)}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class se extends _e{observe(e){this.listenTo(e,"load",(t,i)=>{const n=i.target;this.checkShouldIgnoreEventFromTarget(n)||n.tagName=="IMG"&&this._fireEvents(i)},{useCapture:!0})}stopObserving(e){this.stopListening(e)}_fireEvents(e){this.isEnabled&&(this.document.fire("layoutChanged"),this.document.fire("imageLoaded",e))}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class ot extends b{constructor(e){super(e);const t=e.config.get("image.insert.type");e.plugins.has("ImageBlockEditing")||t==="block"&&k("image-block-plugin-required"),e.plugins.has("ImageInlineEditing")||t==="inline"&&k("image-inline-plugin-required")}refresh(){const e=this.editor.plugins.get("ImageUtils");this.isEnabled=e.isImageAllowed()}execute(e){const t=J(e.source),i=this.editor.model.document.selection,n=this.editor.plugins.get("ImageUtils"),o=Object.fromEntries(i.getAttributes());t.forEach((a,l)=>{const r=i.getSelectedElement();if(typeof a=="string"&&(a={src:a}),l&&r&&n.isImage(r)){const m=this.editor.model.createPositionAfter(r);n.insertImage({...a,...o},m)}else n.insertImage({...a,...o})})}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class at extends b{refresh(){const t=this.editor.plugins.get("ImageUtils"),i=this.editor.model.document.selection.getSelectedElement();this.isEnabled=t.isImage(i),this.value=this.isEnabled?i.getAttribute("src"):null}execute(e){const t=this.editor.model.document.selection.getSelectedElement();this.editor.model.change(i=>{i.setAttribute("src",e.source,t),i.removeAttribute("srcset",t),i.removeAttribute("sizes",t)})}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class oe extends h{static get requires(){return[f]}static get pluginName(){return"ImageEditing"}init(){const e=this.editor,t=e.conversion;e.editing.view.addObserver(se),t.for("upcast").attributeToAttribute({view:{name:"img",key:"alt"},model:"alt"}).attributeToAttribute({view:{name:"img",key:"srcset"},model:{key:"srcset",value:o=>{const a={data:o.getAttribute("srcset")};return o.hasAttribute("width")&&(a.width=o.getAttribute("width")),a}}});const i=new ot(e),n=new at(e);e.commands.add("insertImage",i),e.commands.add("replaceImageSource",n),e.commands.add("imageInsert",i)}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class ae extends b{constructor(e,t){super(e),this._modelElementName=t}refresh(){const t=this.editor.plugins.get("ImageUtils"),i=t.getClosestSelectedImageElement(this.editor.model.document.selection);this._modelElementName==="imageBlock"?this.isEnabled=t.isInlineImage(i):this.isEnabled=t.isBlockImage(i)}execute(){const e=this.editor,t=this.editor.model,i=e.plugins.get("ImageUtils"),n=i.getClosestSelectedImageElement(t.document.selection),o=Object.fromEntries(n.getAttributes());return!o.src&&!o.uploadId?null:t.change(a=>{const l=Array.from(t.markers).filter(c=>c.getRange().containsItem(n)),r=i.insertImage(o,t.createSelection(n,"on"),this._modelElementName);if(!r)return null;const m=a.createRangeOn(r);for(const c of l){const g=c.getRange(),u=g.root.rootName!="$graveyard"?g.getJoined(m,!0):m;a.updateMarker(c,{range:u})}return{oldElement:n,newElement:r}})}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class le extends h{static get requires(){return[oe,f,O]}static get pluginName(){return"ImageBlockEditing"}init(){const e=this.editor;e.model.schema.register("imageBlock",{inheritAllFrom:"$blockObject",allowAttributes:["alt","src","srcset"]}),this._setupConversion(),e.plugins.has("ImageInlineEditing")&&(e.commands.add("imageTypeBlock",new ae(this.editor,"imageBlock")),this._setupClipboardIntegration())}_setupConversion(){const e=this.editor,t=e.t,i=e.conversion,n=e.plugins.get("ImageUtils");i.for("dataDowncast").elementToStructure({model:"imageBlock",view:(o,{writer:a})=>P(a)}),i.for("editingDowncast").elementToStructure({model:"imageBlock",view:(o,{writer:a})=>n.toImageWidget(P(a),a,t("image widget"))}),i.for("downcast").add(_(n,"imageBlock","src")).add(_(n,"imageBlock","alt")).add(ne(n,"imageBlock")),i.for("upcast").elementToElement({view:Y(e,"imageBlock"),model:(o,{writer:a})=>a.createElement("imageBlock",o.hasAttribute("src")?{src:o.getAttribute("src")}:void 0)}).add(st(n))}_setupClipboardIntegration(){const e=this.editor,t=e.model,i=e.editing.view,n=e.plugins.get("ImageUtils"),o=e.plugins.get("ClipboardPipeline");this.listenTo(o,"inputTransformation",(a,l)=>{const r=Array.from(l.content.getChildren());let m;if(!r.every(n.isInlineImageView))return;l.targetRanges?m=e.editing.mapper.toModelRange(l.targetRanges[0]):m=t.document.selection.getFirstRange();const c=t.createSelection(m);if(N(t.schema,c)==="imageBlock"){const g=new z(i.document),u=r.map(d=>g.createElement("figure",{class:"image"},d));l.content=g.createDocumentFragment(u)}})}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class lt extends h{static get requires(){return[le,Z,ie]}static get pluginName(){return"ImageBlock"}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class rt extends h{static get requires(){return[oe,f,O]}static get pluginName(){return"ImageInlineEditing"}init(){const e=this.editor,t=e.model.schema;t.register("imageInline",{inheritAllFrom:"$inlineObject",allowAttributes:["alt","src","srcset"]}),t.addChildCheck((i,n)=>{if(i.endsWith("caption")&&n.name==="imageInline")return!1}),this._setupConversion(),e.plugins.has("ImageBlockEditing")&&(e.commands.add("imageTypeInline",new ae(this.editor,"imageInline")),this._setupClipboardIntegration())}_setupConversion(){const e=this.editor,t=e.t,i=e.conversion,n=e.plugins.get("ImageUtils");i.for("dataDowncast").elementToElement({model:"imageInline",view:(o,{writer:a})=>a.createEmptyElement("img")}),i.for("editingDowncast").elementToStructure({model:"imageInline",view:(o,{writer:a})=>n.toImageWidget(Ze(a),a,t("image widget"))}),i.for("downcast").add(_(n,"imageInline","src")).add(_(n,"imageInline","alt")).add(ne(n,"imageInline")),i.for("upcast").elementToElement({view:Y(e,"imageInline"),model:(o,{writer:a})=>a.createElement("imageInline",o.hasAttribute("src")?{src:o.getAttribute("src")}:void 0)})}_setupClipboardIntegration(){const e=this.editor,t=e.model,i=e.editing.view,n=e.plugins.get("ImageUtils"),o=e.plugins.get("ClipboardPipeline");this.listenTo(o,"inputTransformation",(a,l)=>{const r=Array.from(l.content.getChildren());let m;if(!r.every(n.isBlockImageView))return;l.targetRanges?m=e.editing.mapper.toModelRange(l.targetRanges[0]):m=t.document.selection.getFirstRange();const c=t.createSelection(m);if(N(t.schema,c)==="imageInline"){const g=new z(i.document),u=r.map(d=>d.childCount===1?(Array.from(d.getAttributes()).forEach(p=>g.setAttribute(...p,n.findViewImgElement(d))),d.getChild(0)):d);l.content=g.createDocumentFragment(u)}})}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class mt extends h{static get requires(){return[rt,Z,ie]}static get pluginName(){return"ImageInline"}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class ii extends h{static get requires(){return[lt,mt]}static get pluginName(){return"Image"}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class ct extends b{refresh(){const e=this.editor,t=e.plugins.get("ImageCaptionUtils"),i=e.plugins.get("ImageUtils");if(!e.plugins.has(le)){this.isEnabled=!1,this.value=!1;return}const n=e.model.document.selection,o=n.getSelectedElement();if(!o){const a=t.getCaptionFromModelSelection(n);this.isEnabled=!!a,this.value=!!a;return}this.isEnabled=i.isImage(o),this.isEnabled?this.value=!!t.getCaptionFromImageModelElement(o):this.value=!1}execute(e={}){const{focusCaptionOnShow:t}=e;this.editor.model.change(i=>{this.value?this._hideImageCaption(i):this._showImageCaption(i,t)})}_showImageCaption(e,t){const n=this.editor.model.document.selection,o=this.editor.plugins.get("ImageCaptionEditing"),a=this.editor.plugins.get("ImageUtils");let l=n.getSelectedElement();const r=o._getSavedCaption(l);a.isInlineImage(l)&&(this.editor.execute("imageTypeBlock"),l=n.getSelectedElement());const m=r||e.createElement("caption");e.append(m,l),t&&e.setSelection(m,"in")}_hideImageCaption(e){const t=this.editor,i=t.model.document.selection,n=t.plugins.get("ImageCaptionEditing"),o=t.plugins.get("ImageCaptionUtils");let a=i.getSelectedElement(),l;a?l=o.getCaptionFromImageModelElement(a):(l=o.getCaptionFromModelSelection(i),a=l.parent),n._saveCaption(a,l),e.setSelection(a,"on"),e.remove(l)}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class re extends h{static get pluginName(){return"ImageCaptionUtils"}static get requires(){return[f]}getCaptionFromImageModelElement(e){for(const t of e.getChildren())if(t&&t.is("element","caption"))return t;return null}getCaptionFromModelSelection(e){const t=this.editor.plugins.get("ImageUtils"),i=e.getFirstPosition().findAncestor("caption");return i&&t.isBlockImage(i.parent)?i:null}matchImageCaptionViewElement(e){const t=this.editor.plugins.get("ImageUtils");return e.name=="figcaption"&&t.isBlockImageView(e.parent)?{name:!0}:null}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class gt extends h{static get requires(){return[f,re]}static get pluginName(){return"ImageCaptionEditing"}constructor(e){super(e),this._savedCaptionsMap=new WeakMap}init(){const e=this.editor,t=e.model.schema;t.isRegistered("caption")?t.extend("caption",{allowIn:"imageBlock"}):t.register("caption",{allowIn:"imageBlock",allowContentOf:"$block",isLimit:!0}),e.commands.add("toggleImageCaption",new ct(this.editor)),this._setupConversion(),this._setupImageTypeCommandsIntegration(),this._registerCaptionReconversion()}_setupConversion(){const e=this.editor,t=e.editing.view,i=e.plugins.get("ImageUtils"),n=e.plugins.get("ImageCaptionUtils"),o=e.t;e.conversion.for("upcast").elementToElement({view:a=>n.matchImageCaptionViewElement(a),model:"caption"}),e.conversion.for("dataDowncast").elementToElement({model:"caption",view:(a,{writer:l})=>i.isBlockImage(a.parent)?l.createContainerElement("figcaption"):null}),e.conversion.for("editingDowncast").elementToElement({model:"caption",view:(a,{writer:l})=>{if(!i.isBlockImage(a.parent))return null;const r=l.createEditableElement("figcaption");l.setCustomProperty("imageCaption",!0,r),Ae({view:t,element:r,text:o("Enter image caption"),keepOnFocus:!0});const m=a.parent.getAttribute("alt"),c=m?o("Caption for image: %0",[m]):o("Caption for the image");return Ve(r,l,{label:c})}})}_setupImageTypeCommandsIntegration(){const e=this.editor,t=e.plugins.get("ImageUtils"),i=e.plugins.get("ImageCaptionUtils"),n=e.commands.get("imageTypeInline"),o=e.commands.get("imageTypeBlock"),a=l=>{if(!l.return)return;const{oldElement:r,newElement:m}=l.return;/* istanbul ignore if: paranoid check -- @preserve */if(!r)return;if(t.isBlockImage(r)){const g=i.getCaptionFromImageModelElement(r);if(g){this._saveCaption(m,g);return}}const c=this._getSavedCaption(r);c&&this._saveCaption(m,c)};n&&this.listenTo(n,"execute",a,{priority:"low"}),o&&this.listenTo(o,"execute",a,{priority:"low"})}_getSavedCaption(e){const t=this._savedCaptionsMap.get(e);return t?Be.fromJSON(t):null}_saveCaption(e,t){this._savedCaptionsMap.set(e,t.toJSON())}_registerCaptionReconversion(){const e=this.editor,t=e.model,i=e.plugins.get("ImageUtils"),n=e.plugins.get("ImageCaptionUtils");t.document.on("change:data",()=>{const o=t.document.differ.getChanges();for(const a of o){if(a.attributeKey!=="alt")continue;const l=a.range.start.nodeAfter;if(i.isBlockImage(l)){const r=n.getCaptionFromImageModelElement(l);if(!r)return;e.editing.reconvertItem(r)}}})}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class dt extends h{static get requires(){return[re]}static get pluginName(){return"ImageCaptionUI"}init(){const e=this.editor,t=e.editing.view,i=e.plugins.get("ImageCaptionUtils"),n=e.t;e.ui.componentFactory.add("toggleImageCaption",o=>{const a=e.commands.get("toggleImageCaption"),l=new y(o);return l.set({icon:I.caption,tooltip:!0,isToggleable:!0}),l.bind("isOn","isEnabled").to(a,"value","isEnabled"),l.bind("label").to(a,"value",r=>n(r?"Toggle caption off":"Toggle caption on")),this.listenTo(l,"execute",()=>{e.execute("toggleImageCaption",{focusCaptionOnShow:!0});const r=i.getCaptionFromModelSelection(e.model.document.selection);if(r){const m=e.editing.mapper.toViewElement(r);t.scrollToTheSelection(),t.change(c=>{c.addClass("image__caption_highlighted",m)})}e.editing.view.focus()}),l})}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class ni extends h{static get requires(){return[gt,dt]}static get pluginName(){return"ImageCaption"}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class ut extends b{refresh(){const e=this.editor,i=e.plugins.get("ImageUtils").getClosestSelectedImageElement(e.model.document.selection);this.isEnabled=!!i,!i||!i.hasAttribute("width")?this.value=null:this.value={width:i.getAttribute("width"),height:null}}execute(e){const t=this.editor,i=t.model,o=t.plugins.get("ImageUtils").getClosestSelectedImageElement(i.document.selection);this.value={width:e.width,height:null},o&&i.change(a=>{a.setAttribute("width",e.width,o)})}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class pt extends h{static get requires(){return[f]}static get pluginName(){return"ImageResizeEditing"}constructor(e){super(e),e.config.define("image",{resizeUnit:"%",resizeOptions:[{name:"resizeImage:original",value:null,icon:"original"},{name:"resizeImage:25",value:"25",icon:"small"},{name:"resizeImage:50",value:"50",icon:"medium"},{name:"resizeImage:75",value:"75",icon:"large"}]})}init(){const e=this.editor,t=new ut(e);this._registerSchema(),this._registerConverters("imageBlock"),this._registerConverters("imageInline"),e.commands.add("resizeImage",t),e.commands.add("imageResize",t)}_registerSchema(){this.editor.plugins.has("ImageBlockEditing")&&this.editor.model.schema.extend("imageBlock",{allowAttributes:"width"}),this.editor.plugins.has("ImageInlineEditing")&&this.editor.model.schema.extend("imageInline",{allowAttributes:"width"})}_registerConverters(e){const t=this.editor;t.conversion.for("downcast").add(i=>i.on(`attribute:width:${e}`,(n,o,a)=>{if(!a.consumable.consume(o.item,n.name))return;const l=a.writer,r=a.mapper.toViewElement(o.item);o.attributeNewValue!==null?(l.setStyle("width",o.attributeNewValue,r),l.addClass("image_resized",r)):(l.removeStyle("width",r),l.removeClass("image_resized",r))})),t.conversion.for("upcast").attributeToAttribute({view:{name:e==="imageBlock"?"figure":"img",styles:{width:/.+/}},model:{key:"width",value:i=>i.getStyle("width")}})}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */const B={small:I.objectSizeSmall,medium:I.objectSizeMedium,large:I.objectSizeLarge,original:I.objectSizeFull};class si extends h{static get requires(){return[pt]}static get pluginName(){return"ImageResizeButtons"}constructor(e){super(e),this._resizeUnit=e.config.get("image.resizeUnit")}init(){const e=this.editor,t=e.config.get("image.resizeOptions"),i=e.commands.get("resizeImage");this.bind("isEnabled").to(i);for(const n of t)this._registerImageResizeButton(n);this._registerImageResizeDropdown(t)}_registerImageResizeButton(e){const t=this.editor,{name:i,value:n,icon:o}=e,a=n?n+this._resizeUnit:null;t.ui.componentFactory.add(i,l=>{const r=new y(l),m=t.commands.get("resizeImage"),c=this._getOptionLabelValue(e,!0);if(!B[o])throw new ve("imageresizebuttons-missing-icon",t,e);return r.set({label:c,icon:B[o],tooltip:c,isToggleable:!0}),r.bind("isEnabled").to(this),r.bind("isOn").to(m,"value",M(a)),this.listenTo(r,"execute",()=>{t.execute("resizeImage",{width:a})}),r})}_registerImageResizeDropdown(e){const t=this.editor,i=t.t,n=e.find(a=>!a.value),o=a=>{const l=t.commands.get("resizeImage"),r=Q(a,je),m=r.buttonView,c=i("Resize image");return m.set({tooltip:c,commandValue:n.value,icon:B.medium,isToggleable:!0,label:this._getOptionLabelValue(n),withText:!0,class:"ck-resize-image-button",ariaLabel:c,ariaLabelledBy:void 0}),m.bind("label").to(l,"value",g=>g&&g.width?g.width:this._getOptionLabelValue(n)),r.bind("isEnabled").to(this),$e(r,()=>this._getResizeDropdownListItemDefinitions(e,l),{ariaLabel:i("Image resize list"),role:"menu"}),this.listenTo(r,"execute",g=>{t.execute(g.source.commandName,{width:g.source.commandValue}),t.editing.view.focus()}),r};t.ui.componentFactory.add("resizeImage",o),t.ui.componentFactory.add("imageResize",o)}_getOptionLabelValue(e,t=!1){const i=this.editor.t;return e.label?e.label:t?e.value?i("Resize image to %0",e.value+this._resizeUnit):i("Resize image to the original size"):e.value?e.value+this._resizeUnit:i("Original")}_getResizeDropdownListItemDefinitions(e,t){const i=new Se;return e.map(n=>{const o=n.value?n.value+this._resizeUnit:null,a={type:"button",model:new qe({commandName:"resizeImage",commandValue:o,label:this._getOptionLabelValue(n),role:"menuitemradio",withText:!0,icon:null})};a.model.bind("isOn").to(t,"value",M(o)),i.add(a)}),i}}function M(s){return e=>{const t=e;return s===null&&t===s?!0:t!==null&&t.width===s}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */const ht="figure.image.ck-widget > img,figure.image.ck-widget > picture > img,figure.image.ck-widget > a > img,figure.image.ck-widget > a > picture > img,span.image-inline.ck-widget > img,span.image-inline.ck-widget > picture > img",ft=/(image|image-inline)/,U="image_resized";class oi extends h{static get requires(){return[A]}static get pluginName(){return"ImageResizeHandles"}init(){const e=this.editor.commands.get("resizeImage");this.bind("isEnabled").to(e),this._setupResizerCreator()}_setupResizerCreator(){const e=this.editor,t=e.editing.view;t.addObserver(se),this.listenTo(t.document,"imageLoaded",(i,n)=>{if(!n.target.matches(ht))return;const o=e.editing.view.domConverter,l=o.domToView(n.target).findAncestor({classes:ft});let r=this.editor.plugins.get(A).getResizerByViewElement(l);if(r){r.redraw();return}const m=e.editing.mapper,c=m.toModelElement(l);r=e.plugins.get(A).attachTo({unit:e.config.get("image.resizeUnit"),modelElement:c,viewElement:l,editor:e,getHandleHost(g){return g.querySelector("img")},getResizeHost(){return o.mapViewToDom(m.toViewElement(c.parent))},isCentered(){const g=c.getAttribute("imageStyle");return!g||g=="block"||g=="alignCenter"},onCommit(g){t.change(u=>{u.removeClass(U,l)}),e.execute("resizeImage",{width:g})}}),r.on("updateSize",()=>{l.hasClass(U)||t.change(g=>{g.addClass(U,l)})}),r.bind("isEnabled").to(this)})}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class It extends b{constructor(e,t){super(e),this._defaultStyles={imageBlock:!1,imageInline:!1},this._styles=new Map(t.map(i=>{if(i.isDefault)for(const n of i.modelElements)this._defaultStyles[n]=i.name;return[i.name,i]}))}refresh(){const i=this.editor.plugins.get("ImageUtils").getClosestSelectedImageElement(this.editor.model.document.selection);this.isEnabled=!!i,this.isEnabled?i.hasAttribute("imageStyle")?this.value=i.getAttribute("imageStyle"):this.value=this._defaultStyles[i.name]:this.value=!1}execute(e={}){const t=this.editor,i=t.model,n=t.plugins.get("ImageUtils");i.change(o=>{const a=e.value;let l=n.getClosestSelectedImageElement(i.document.selection);a&&this.shouldConvertImageType(a,l)&&(this.editor.execute(n.isBlockImage(l)?"imageTypeInline":"imageTypeBlock"),l=n.getClosestSelectedImageElement(i.document.selection)),!a||this._styles.get(a).isDefault?o.removeAttribute("imageStyle",l):o.setAttribute("imageStyle",a,l)})}shouldConvertImageType(e,t){return!this._styles.get(e).modelElements.includes(t.name)}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */const{objectFullWidth:bt,objectInline:me,objectLeft:ce,objectRight:x,objectCenter:T,objectBlockLeft:ge,objectBlockRight:de}=I,S={get inline(){return{name:"inline",title:"In line",icon:me,modelElements:["imageInline"],isDefault:!0}},get alignLeft(){return{name:"alignLeft",title:"Left aligned image",icon:ce,modelElements:["imageBlock","imageInline"],className:"image-style-align-left"}},get alignBlockLeft(){return{name:"alignBlockLeft",title:"Left aligned image",icon:ge,modelElements:["imageBlock"],className:"image-style-block-align-left"}},get alignCenter(){return{name:"alignCenter",title:"Centered image",icon:T,modelElements:["imageBlock"],className:"image-style-align-center"}},get alignRight(){return{name:"alignRight",title:"Right aligned image",icon:x,modelElements:["imageBlock","imageInline"],className:"image-style-align-right"}},get alignBlockRight(){return{name:"alignBlockRight",title:"Right aligned image",icon:de,modelElements:["imageBlock"],className:"image-style-block-align-right"}},get block(){return{name:"block",title:"Centered image",icon:T,modelElements:["imageBlock"],isDefault:!0}},get side(){return{name:"side",title:"Side image",icon:x,modelElements:["imageBlock"],className:"image-style-side"}}},ue={full:bt,left:ge,right:de,center:T,inlineLeft:ce,inlineRight:x,inline:me},pe=[{name:"imageStyle:wrapText",title:"Wrap text",defaultItem:"imageStyle:alignLeft",items:["imageStyle:alignLeft","imageStyle:alignRight"]},{name:"imageStyle:breakText",title:"Break text",defaultItem:"imageStyle:block",items:["imageStyle:alignBlockLeft","imageStyle:block","imageStyle:alignBlockRight"]}];function wt(s){return(s.configuredStyles.options||[]).map(i=>yt(i)).filter(i=>vt(i,s))}function Et(s,e){return s&&e?{options:["inline","alignLeft","alignRight","alignCenter","alignBlockLeft","alignBlockRight","block","side"]}:s?{options:["block","side"]}:e?{options:["inline","alignLeft","alignRight"]}:{}}function Ct(s){return s.has("ImageBlockEditing")&&s.has("ImageInlineEditing")?[...pe]:[]}function yt(s){return typeof s=="string"?S[s]?s={...S[s]}:s={name:s}:s=St(S[s.name],s),typeof s.icon=="string"&&(s.icon=ue[s.icon]||s.icon),s}function vt(s,{isBlockPluginLoaded:e,isInlinePluginLoaded:t}){const{modelElements:i,name:n}=s;if(!i||!i.length||!n)return he({style:s}),!1;{const o=[e?"imageBlock":null,t?"imageInline":null];if(!i.some(a=>o.includes(a)))return k("image-style-missing-dependency",{style:s,missingPlugins:i.map(a=>a==="imageBlock"?"ImageBlockEditing":"ImageInlineEditing")}),!1}return!0}function St(s,e){const t={...e};for(const i in s)Object.prototype.hasOwnProperty.call(e,i)||(t[i]=s[i]);return t}function he(s){k("image-style-configuration-definition-invalid",s)}const V={normalizeStyles:wt,getDefaultStylesConfiguration:Et,getDefaultDropdownDefinitions:Ct,warnInvalidStyle:he,DEFAULT_OPTIONS:S,DEFAULT_ICONS:ue,DEFAULT_DROPDOWN_DEFINITIONS:pe};/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */function kt(s){return(e,t,i)=>{if(!i.consumable.consume(t.item,e.name))return;const n=W(t.attributeNewValue,s),o=W(t.attributeOldValue,s),a=i.mapper.toViewElement(t.item),l=i.writer;o&&l.removeClass(o.className,a),n&&l.addClass(n.className,a)}}function _t(s){const e={imageInline:s.filter(t=>!t.isDefault&&t.modelElements.includes("imageInline")),imageBlock:s.filter(t=>!t.isDefault&&t.modelElements.includes("imageBlock"))};return(t,i,n)=>{if(!i.modelRange)return;const o=i.viewItem,a=R(i.modelRange.getItems());if(a&&n.schema.checkAttribute(a,"imageStyle"))for(const l of e[a.name])n.consumable.consume(o,{classes:l.className})&&n.writer.setAttribute("imageStyle",l.name,a)}}function W(s,e){for(const t of e)if(t.name===s)return t}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class fe extends h{static get pluginName(){return"ImageStyleEditing"}static get requires(){return[f]}init(){const{normalizeStyles:e,getDefaultStylesConfiguration:t}=V,i=this.editor,n=i.plugins.has("ImageBlockEditing"),o=i.plugins.has("ImageInlineEditing");i.config.define("image.styles",t(n,o)),this.normalizedStyles=e({configuredStyles:i.config.get("image.styles"),isBlockPluginLoaded:n,isInlinePluginLoaded:o}),this._setupConversion(n,o),this._setupPostFixer(),i.commands.add("imageStyle",new It(i,this.normalizedStyles))}_setupConversion(e,t){const i=this.editor,n=i.model.schema,o=kt(this.normalizedStyles),a=_t(this.normalizedStyles);i.editing.downcastDispatcher.on("attribute:imageStyle",o),i.data.downcastDispatcher.on("attribute:imageStyle",o),e&&(n.extend("imageBlock",{allowAttributes:"imageStyle"}),i.data.upcastDispatcher.on("element:figure",a,{priority:"low"})),t&&(n.extend("imageInline",{allowAttributes:"imageStyle"}),i.data.upcastDispatcher.on("element:img",a,{priority:"low"}))}_setupPostFixer(){const e=this.editor,t=e.model.document,i=e.plugins.get(f),n=new Map(this.normalizedStyles.map(o=>[o.name,o]));t.registerPostFixer(o=>{let a=!1;for(const l of t.differ.getChanges())if(l.type=="insert"||l.type=="attribute"&&l.attributeKey=="imageStyle"){let r=l.type=="insert"?l.position.nodeAfter:l.range.start.nodeAfter;if(r&&r.is("element","paragraph")&&r.childCount>0&&(r=r.getChild(0)),!i.isImage(r))continue;const m=r.getAttribute("imageStyle");if(!m)continue;const c=n.get(m);(!c||!c.modelElements.includes(r.name))&&(o.removeAttribute("imageStyle",r),a=!0)}return a})}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class At extends h{static get requires(){return[fe]}static get pluginName(){return"ImageStyleUI"}get localizedDefaultStylesTitles(){const e=this.editor.t;return{"Wrap text":e("Wrap text"),"Break text":e("Break text"),"In line":e("In line"),"Full size image":e("Full size image"),"Side image":e("Side image"),"Left aligned image":e("Left aligned image"),"Centered image":e("Centered image"),"Right aligned image":e("Right aligned image")}}init(){const e=this.editor.plugins,t=this.editor.config.get("image.toolbar")||[],i=e.get("ImageStyleEditing"),n=q(i.normalizedStyles,this.localizedDefaultStylesTitles);for(const a of n)this._createButton(a);const o=q([...t.filter(X),...V.getDefaultDropdownDefinitions(e)],this.localizedDefaultStylesTitles);for(const a of o)this._createDropdown(a,n)}_createDropdown(e,t){const i=this.editor.ui.componentFactory;i.add(e.name,n=>{let o;const{defaultItem:a,items:l,title:r}=e,m=l.filter(d=>t.find(({name:p})=>j(p)===d)).map(d=>{const p=i.create(d);return d===a&&(o=p),p});l.length!==m.length&&V.warnInvalidStyle({dropdown:e});const c=Q(n,He),g=c.buttonView,u=g.arrowView;return Ge(c,m,{enableActiveItemFocusOnDropdownOpen:!0}),g.set({label:$(r,o.label),class:null,tooltip:!0}),u.unbind("label"),u.set({label:r}),g.bind("icon").toMany(m,"isOn",(...d)=>{const p=d.findIndex(E);return p<0?o.icon:m[p].icon}),g.bind("label").toMany(m,"isOn",(...d)=>{const p=d.findIndex(E);return $(r,p<0?o.label:m[p].label)}),g.bind("isOn").toMany(m,"isOn",(...d)=>d.some(E)),g.bind("class").toMany(m,"isOn",(...d)=>d.some(E)?"ck-splitbutton_flatten":void 0),g.on("execute",()=>{m.some(({isOn:d})=>d)?c.isOpen=!c.isOpen:o.fire("execute")}),c.bind("isEnabled").toMany(m,"isEnabled",(...d)=>d.some(E)),this.listenTo(c,"execute",()=>{this.editor.editing.view.focus()}),c})}_createButton(e){const t=e.name;this.editor.ui.componentFactory.add(j(t),i=>{const n=this.editor.commands.get("imageStyle"),o=new y(i);return o.set({label:e.title,icon:e.icon,tooltip:!0,isToggleable:!0}),o.bind("isEnabled").to(n,"isEnabled"),o.bind("isOn").to(n,"value",a=>a===t),o.on("execute",this._executeCommand.bind(this,t)),o})}_executeCommand(e){this.editor.execute("imageStyle",{value:e}),this.editor.editing.view.focus()}}function q(s,e){for(const t of s)e[t.title]&&(t.title=e[t.title]);return s}function j(s){return`imageStyle:${s}`}function $(s,e){return(s?s+": ":"")+e}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class ai extends h{static get requires(){return[fe,At]}static get pluginName(){return"ImageStyle"}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class li extends h{static get requires(){return[F,f]}static get pluginName(){return"ImageToolbar"}afterInit(){const e=this.editor,t=e.t,i=e.plugins.get(F),n=e.plugins.get("ImageUtils");i.register("image",{ariaLabel:t("Image toolbar"),items:Bt(e.config.get("image.toolbar")||[]),getRelatedElement:o=>n.getClosestSelectedImageWidget(o)})}}function Bt(s){return s.map(e=>X(e)?e.name:e)}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */function Ie(s){const e=s.map(t=>t.replace("+","\\+"));return new RegExp(`^image\\/(${e.join("|")})$`)}function Ut(s){return new Promise((e,t)=>{const i=s.getAttribute("src");fetch(i).then(n=>n.blob()).then(n=>{const o=be(n,i),l=`image.${o.replace("image/","")}`,r=new File([n],l,{type:o});e(r)}).catch(n=>n&&n.name==="TypeError"?Tt(i).then(e).catch(t):t(n))})}function xt(s,e){return!s.isInlineImageView(e)||!e.getAttribute("src")?!1:!!e.getAttribute("src").match(/^data:image\/\w+;base64,/g)||!!e.getAttribute("src").match(/^blob:/g)}function be(s,e){return s.type?s.type:e.match(/data:(image\/\w+);base64/)?e.match(/data:(image\/\w+);base64/)[1].toLowerCase():"image/jpeg"}function Tt(s){return Vt(s).then(e=>{const t=be(e,s),n=`image.${t.replace("image/","")}`;return new File([e],n,{type:t})})}function Vt(s){return new Promise((e,t)=>{const i=D.document.createElement("img");i.addEventListener("load",()=>{const n=D.document.createElement("canvas");n.width=i.width,n.height=i.height,n.getContext("2d").drawImage(i,0,0),n.toBlob(a=>a?e(a):t())}),i.addEventListener("error",()=>t()),i.src=s})}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class Rt extends h{static get pluginName(){return"ImageUploadUI"}init(){const e=this.editor,t=e.t,i=n=>{const o=new Ke(n),a=e.commands.get("uploadImage"),l=e.config.get("image.upload.types"),r=Ie(l);return o.set({acceptedType:l.map(m=>`image/${m}`).join(","),allowMultipleFiles:!0}),o.buttonView.set({label:t("Insert image"),icon:I.image,tooltip:!0}),o.buttonView.bind("isEnabled").to(a),o.on("done",(m,c)=>{const g=Array.from(c).filter(u=>r.test(u.type));g.length&&(e.execute("uploadImage",{file:g}),e.editing.view.focus())}),o};e.ui.componentFactory.add("uploadImage",i),e.ui.componentFactory.add("imageUpload",i)}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class zt extends h{static get pluginName(){return"ImageUploadProgress"}constructor(e){super(e),this.uploadStatusChange=(t,i,n)=>{const o=this.editor,a=i.item,l=a.getAttribute("uploadId");if(!n.consumable.consume(i.item,t.name))return;const r=o.plugins.get("ImageUtils"),m=o.plugins.get(C),c=l?i.attributeNewValue:null,g=this.placeholder,u=o.editing.mapper.toViewElement(a),d=n.writer;if(c=="reading"){H(u,d),G(r,g,u,d);return}if(c=="uploading"){const p=m.loaders.get(l);H(u,d),p?(K(u,d),Nt(u,d,p,o.editing.view),Mt(r,u,d,p)):G(r,g,u,d);return}c=="complete"&&m.loaders.get(l)&&Ft(u,d,o.editing.view),Dt(u,d),K(u,d),Ot(u,d)},this.placeholder="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="}init(){const e=this.editor;e.plugins.has("ImageBlockEditing")&&e.editing.downcastDispatcher.on("attribute:uploadStatus:imageBlock",this.uploadStatusChange),e.plugins.has("ImageInlineEditing")&&e.editing.downcastDispatcher.on("attribute:uploadStatus:imageInline",this.uploadStatusChange)}}function H(s,e){s.hasClass("ck-appear")||e.addClass("ck-appear",s)}function Ot(s,e){e.removeClass("ck-appear",s)}function G(s,e,t,i){t.hasClass("ck-image-upload-placeholder")||i.addClass("ck-image-upload-placeholder",t);const n=s.findViewImgElement(t);n.getAttribute("src")!==e&&i.setAttribute("src",e,n),we(t,"placeholder")||i.insert(i.createPositionAfter(n),Pt(i))}function K(s,e){s.hasClass("ck-image-upload-placeholder")&&e.removeClass("ck-image-upload-placeholder",s),Ee(s,e,"placeholder")}function Nt(s,e,t,i){const n=Lt(e);e.insert(e.createPositionAt(s,"end"),n),t.on("change:uploadedPercent",(o,a,l)=>{i.change(r=>{r.setStyle("width",l+"%",n)})})}function Dt(s,e){Ee(s,e,"progressBar")}function Ft(s,e,t){const i=e.createUIElement("div",{class:"ck-image-upload-complete-icon"});e.insert(e.createPositionAt(s,"end"),i),setTimeout(()=>{t.change(n=>n.remove(n.createRangeOn(i)))},3e3)}function Lt(s){const e=s.createUIElement("div",{class:"ck-progress-bar"});return s.setCustomProperty("progressBar",!0,e),e}function Pt(s){const e=s.createUIElement("div",{class:"ck-upload-placeholder-loader"});return s.setCustomProperty("placeholder",!0,e),e}function we(s,e){for(const t of s.getChildren())if(t.getCustomProperty(e))return t}function Ee(s,e,t){const i=we(s,t);i&&e.remove(e.createRangeOn(i))}function Mt(s,e,t,i){if(i.data){const n=s.findViewImgElement(e);t.setAttribute("src",i.data,n)}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class Wt extends b{refresh(){const e=this.editor,t=e.plugins.get("ImageUtils"),i=e.model.document.selection.getSelectedElement();this.isEnabled=t.isImageAllowed()||t.isImage(i)}execute(e){const t=J(e.file),i=this.editor.model.document.selection,n=this.editor.plugins.get("ImageUtils"),o=Object.fromEntries(i.getAttributes());t.forEach((a,l)=>{const r=i.getSelectedElement();if(l&&r&&n.isImage(r)){const m=this.editor.model.createPositionAfter(r);this._uploadImage(a,o,m)}else this._uploadImage(a,o)})}_uploadImage(e,t,i){const n=this.editor,a=n.plugins.get(C).createLoader(e),l=n.plugins.get("ImageUtils");a&&l.insertImage({...t,uploadId:a.id},i)}}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class qt extends h{static get requires(){return[C,L,O,f]}static get pluginName(){return"ImageUploadEditing"}constructor(e){super(e),e.config.define("image",{upload:{types:["jpeg","png","gif","bmp","webp","tiff"]}}),this._uploadImageElements=new Map}init(){const e=this.editor,t=e.model.document,i=e.conversion,n=e.plugins.get(C),o=e.plugins.get("ImageUtils"),a=e.plugins.get("ClipboardPipeline"),l=Ie(e.config.get("image.upload.types")),r=new Wt(e);e.commands.add("uploadImage",r),e.commands.add("imageUpload",r),i.for("upcast").attributeToAttribute({view:{name:"img",key:"uploadId"},model:"uploadId"}),this.listenTo(e.editing.view.document,"clipboardInput",(m,c)=>{if(jt(c.dataTransfer))return;const g=Array.from(c.dataTransfer.files).filter(u=>u?l.test(u.type):!1);g.length&&(m.stop(),e.model.change(u=>{c.targetRanges&&u.setSelection(c.targetRanges.map(d=>e.editing.mapper.toModelRange(d))),e.model.enqueueChange(()=>{e.execute("uploadImage",{file:g})})}))}),this.listenTo(a,"inputTransformation",(m,c)=>{const g=Array.from(e.editing.view.createRangeIn(c.content)).map(d=>d.item).filter(d=>xt(o,d)&&!d.getAttribute("uploadProcessed")).map(d=>({promise:Ut(d),imageElement:d}));if(!g.length)return;const u=new z(e.editing.view.document);for(const d of g){u.setAttribute("uploadProcessed",!0,d.imageElement);const p=n.createLoader(d.promise);p&&(u.setAttribute("src","",d.imageElement),u.setAttribute("uploadId",p.id,d.imageElement))}}),e.editing.view.document.on("dragover",(m,c)=>{c.preventDefault()}),t.on("change",()=>{const m=t.differ.getChanges({includeChangesInGraveyard:!0}).reverse(),c=new Set;for(const g of m)if(g.type=="insert"&&g.name!="$text"){const u=g.position.nodeAfter,d=g.position.root.rootName=="$graveyard";for(const p of $t(e,u)){const w=p.getAttribute("uploadId");if(!w)continue;const v=n.loaders.get(w);v&&(d?c.has(w)||v.abort():(c.add(w),this._uploadImageElements.set(w,p),v.status=="idle"&&this._readAndUpload(v)))}}}),this.on("uploadComplete",(m,{imageElement:c,data:g})=>{const u=g.urls?g.urls:g;this.editor.model.change(d=>{d.setAttribute("src",u.default,c),this._parseAndSetSrcsetAttributeOnImage(u,c,d)})},{priority:"low"})}afterInit(){const e=this.editor.model.schema;this.editor.plugins.has("ImageBlockEditing")&&e.extend("imageBlock",{allowAttributes:["uploadId","uploadStatus"]}),this.editor.plugins.has("ImageInlineEditing")&&e.extend("imageInline",{allowAttributes:["uploadId","uploadStatus"]})}_readAndUpload(e){const t=this.editor,i=t.model,n=t.locale.t,o=t.plugins.get(C),a=t.plugins.get(L),l=t.plugins.get("ImageUtils"),r=this._uploadImageElements;return i.enqueueChange({isUndoable:!1},c=>{c.setAttribute("uploadStatus","reading",r.get(e.id))}),e.read().then(()=>{const c=e.upload(),g=r.get(e.id);/* istanbul ignore next -- @preserve */if(ke.isSafari){const u=t.editing.mapper.toViewElement(g),d=l.findViewImgElement(u);t.editing.view.once("render",()=>{if(!d.parent)return;const p=t.editing.view.domConverter.mapViewToDom(d.parent);if(!p)return;const w=p.style.display;p.style.display="none",p._ckHack=p.offsetHeight,p.style.display=w})}return i.enqueueChange({isUndoable:!1},u=>{u.setAttribute("uploadStatus","uploading",g)}),c}).then(c=>{i.enqueueChange({isUndoable:!1},g=>{const u=r.get(e.id);g.setAttribute("uploadStatus","complete",u),this.fire("uploadComplete",{data:c,imageElement:u})}),m()}).catch(c=>{if(e.status!=="error"&&e.status!=="aborted")throw c;e.status=="error"&&c&&a.showWarning(c,{title:n("Upload failed"),namespace:"upload"}),i.enqueueChange({isUndoable:!1},g=>{g.remove(r.get(e.id))}),m()});function m(){i.enqueueChange({isUndoable:!1},c=>{const g=r.get(e.id);c.removeAttribute("uploadId",g),c.removeAttribute("uploadStatus",g),r.delete(e.id)}),o.destroyLoader(e)}}_parseAndSetSrcsetAttributeOnImage(e,t,i){let n=0;const o=Object.keys(e).filter(a=>{const l=parseInt(a,10);if(!isNaN(l))return n=Math.max(n,l),!0}).map(a=>`${e[a]} ${a}w`).join(", ");o!=""&&i.setAttribute("srcset",{data:o,width:n},t)}}function jt(s){return Array.from(s.types).includes("text/html")&&s.getData("text/html")!==""}function $t(s,e){const t=s.plugins.get("ImageUtils");return Array.from(s.model.createRangeOn(e)).filter(i=>t.isImage(i.item)).map(i=>i.item)}/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class ri extends h{static get pluginName(){return"ImageUpload"}static get requires(){return[qt,Rt,zt]}}export{ii as I,ni as a,ai as b,li as c,ri as d,pt as e,oi as f,si as g};
