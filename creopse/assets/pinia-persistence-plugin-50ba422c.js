function A(t){return"key"in t}function F(t=32){let o="";const p="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",v=p.length;let m=0;for(;m<t;)o+=p.charAt(Math.floor(Math.random()*v)),m+=1;return o}function k(t){const o=[];let p=null;const v=(e,n)=>(t!=null&&t.storeKeysPrefix?(t==null?void 0:t.storeKeysPrefix)+"_":"")+((A(e)?e==null?void 0:e.key:n)||n),m=e=>{var n,r;return{storage:e.storage||localStorage,serialize:((n=e==null?void 0:e.serializer)==null?void 0:n.serialize)||JSON.stringify,deserialize:((r=e==null?void 0:e.serializer)==null?void 0:r.deserialize)||JSON.parse}},S=()=>(!p&&o.length&&$(o[0].storageItem,o[0].store,v(o[0].storageItem,o[0].store.$id),o[0].id),setTimeout(S,500)),$=(e,n,r,i)=>{const{storage:I,serialize:y,deserialize:P}=m(e);let f=P(y(n.$state));i&&(p=i),f=Object.keys(f).reduce((s,a)=>{const b=!e.includePaths||!e.includePaths.length||e.includePaths.includes(a),u=!e.excludePaths||!e.excludePaths.length||!e.excludePaths.includes(a);return b&&u&&(s[a]=f[a]),s},{});try{const s=I.setItem(r,y(f));s instanceof Promise&&(n.$persistence.pending=!0,s.then(function(){i&&o.splice(o.findIndex(a=>i==a.id),1)}).catch(function(){}).finally(function(){i&&(p=null),n.$persistence.pending=!1}))}catch(s){t!=null&&t.debug&&console.error(s)}},x=(t==null?void 0:t.assertStorage)||(e=>{const n="@@",r=e.setItem(n,"1"),i=function(){e.removeItem(n)};r instanceof Promise?r.then(i):i()});return e=>{var n,r,i,I,y,P;e.store.$persistence={pending:!1};const f=(n=t==null?void 0:t.storageItemsDefault)!=null&&n.length?t==null?void 0:t.storageItemsDefault:[{storage:localStorage}];let s=!1;e.options.persistence&&typeof e.options.persistence.enabled<"u"?e.options.persistence.enabled&&(s=!0):t?s=t.persistenceDefault??!0:s=!0;const a=(t==null?void 0:t.ensureAsyncStorageUpdateOrder)??!0,b=u=>{const{storage:l,deserialize:g}=m(u),d=v(u,e.store.$id),c=l.getItem(d);if(c){try{c instanceof Promise?c.then(h=>{e.store.$patch(g(h))}):e.store.$patch(g(c))}catch(h){t!=null&&t.debug&&console.error(h)}$(u,e.store,d)}};if(s){const u=(I=(i=(r=e.options)==null?void 0:r.persistence)==null?void 0:i.storageItems)!=null&&I.length?(P=(y=e.options)==null?void 0:y.persistence)==null?void 0:P.storageItems:f;u.forEach((l,g)=>{var d,c;let h;try{h=x(l.storage||localStorage)}catch(z){t!=null&&t.debug&&console.warn(z)}g==0&&(((c=(d=e.options)==null?void 0:d.persistence)==null?void 0:c.beforeHydrate)||function(){})(e.store.$state),h instanceof Promise?h.then(()=>b(l)).catch(z=>{t!=null&&t.debug&&console.warn(z)}):b(l)}),e.store.$subscribe(()=>{u.forEach(l=>{var g,d,c;a&&(((g=l.storage)==null?void 0:g.getItem.constructor.name)==="AsyncFunction"||((d=l.storage)==null?void 0:d.setItem.constructor.name)==="AsyncFunction"||((c=l.storage)==null?void 0:c.removeItem.constructor.name)==="AsyncFunction")?o.push({id:F(),storageItem:l,store:e.store}):$(l,e.store,v(l,e.store.$id))})}),a&&S()}}}export{k as J};
