function x(t){return"key"in t}function S(t){const P=[];let $=null;const y=(e,n)=>(t!=null&&t.storeKeysPrefix?t?.storeKeysPrefix+"_":"")+((x(e)?e?.key:n)||n),b=e=>{var n,o;return{storage:e.storage||localStorage,serialize:((n=e?.serializer)==null?void 0:n.serialize)||JSON.stringify,deserialize:((o=e?.serializer)==null?void 0:o.deserialize)||JSON.parse}},z=(e,n,o,i)=>{const{storage:p,serialize:g,deserialize:h}=b(e);let d=h(g(n.$state));d=Object.keys(d).reduce((s,r)=>{const c=!e.includePaths||!e.includePaths.length||e.includePaths.includes(r),l=!e.excludePaths||!e.excludePaths.length||!e.excludePaths.includes(r);return c&&l&&(s[r]=d[r]),s},{});try{const s=p.setItem(o,g(d));s instanceof Promise&&(n.$persistence.pending=!0,s.then(function(){i&&P.splice(P.findIndex(r=>i==r.id),1)}).catch(function(){}).finally(function(){i&&($=null),n.$persistence.pending=!1}))}catch(s){t!=null&&t.debug&&console.error(s)}},I=t?.assertStorage||(e=>{const o=e.setItem("@@","1"),i=function(){e.removeItem("@@")};o instanceof Promise?o.then(i):i()});return e=>{var n,o,i,p,g,h;e.store.$persistence={pending:!1};const d=(n=t?.storageItemsDefault)!=null&&n.length?t?.storageItemsDefault:[{storage:localStorage}];let s=!1;e.options.persistence&&typeof e.options.persistence.enabled<"u"?e.options.persistence.enabled&&(s=!0):t?s=t.persistenceDefault??!0:s=!0;const r=c=>{const{storage:l,deserialize:v}=b(c),f=y(c,e.store.$id),a=l.getItem(f);if(a){try{a instanceof Promise?a.then(u=>{e.store.$patch(v(u))}):e.store.$patch(v(a))}catch(u){t!=null&&t.debug&&console.error(u)}z(c,e.store,f)}};if(s){const c=(p=(i=(o=e.options)==null?void 0:o.persistence)==null?void 0:i.storageItems)!=null&&p.length?(h=(g=e.options)==null?void 0:g.persistence)==null?void 0:h.storageItems:d;c.forEach((l,v)=>{var f,a;let u;try{u=I(l.storage||localStorage)}catch(m){t!=null&&t.debug&&console.warn(m)}v==0&&(((a=(f=e.options)==null?void 0:f.persistence)==null?void 0:a.beforeHydrate)||function(){})(e.store.$state),u instanceof Promise?u.then(()=>r(l)).catch(m=>{t!=null&&t.debug&&console.warn(m)}):r(l)}),e.store.$subscribe(()=>{c.forEach(l=>{z(l,e.store,y(l,e.store.$id))})})}}}export{S as J};
