import{c as O}from"./hookable-B8xFkYCm.js";const v=new Set(["link","style","script","noscript"]),$=new Set(["title","titleTemplate","script","style","noscript"]),S=new Set(["base","meta","link","style","script","noscript"]),R=new Set(["title","base","htmlAttrs","bodyAttrs","meta","link","style","script","noscript"]),D=new Set(["base","title","titleTemplate","bodyAttrs","htmlAttrs","templateParams"]),W=new Set(["key","tagPosition","tagPriority","tagDuplicateStrategy","innerHTML","textContent","processTemplateParams"]),z=new Set(["templateParams","htmlAttrs","bodyAttrs"]),U=new Set(["theme-color","google-site-verification","og","article","book","profile","twitter","author"]),I=["name","property","http-equiv"],q=new Set(["viewport","description","keywords","robots"]);function j(t){const e=t.split(":");return e.length?U.has(e[1]):!1}function k(t){const{props:e,tag:s}=t;if(D.has(s))return s;if(s==="link"&&e.rel==="canonical")return"canonical";if(e.charset)return"charset";if(t.tag==="meta"){for(const o of I)if(e[o]!==void 0){const a=e[o],l=a.includes(":"),p=q.has(a),m=!(l||p)&&t.key?`:key:${t.key}`:"";return`${s}:${a}${m}`}}if(t.key)return`${s}:key:${t.key}`;if(e.id)return`${s}:id:${e.id}`;if($.has(s)){const o=t.textContent||t.innerHTML;if(o)return`${s}:content:${o}`}}function A(t){const e=t._h||t._d;if(e)return e;const s=t.textContent||t.innerHTML;return s||`${t.tag}:${Object.entries(t.props).map(([o,a])=>`${o}:${String(a)}`).join(",")}`}function H(t,e,s){typeof t==="function"&&(!s||s!=="titleTemplate"&&!(s[0]==="o"&&s[1]==="n"))&&(t=t());let a;if(e&&(a=e(s,t)),Array.isArray(a))return a.map(l=>H(l,e));if(a?.constructor===Object){const l={};for(const p of Object.keys(a))l[p]=H(a[p],e,p);return l}return a}function F(t,e){const s=t==="style"?new Map:new Set;function o(a){const l=a.trim();if(l)if(t==="style"){const[p,...c]=l.split(":").map(m=>m.trim());p&&c.length&&s.set(p,c.join(":"))}else l.split(" ").filter(Boolean).forEach(p=>s.add(p))}return typeof e=="string"?t==="style"?e.split(";").forEach(o):o(e):Array.isArray(e)?e.forEach(a=>o(a)):e&&typeof e=="object"&&Object.entries(e).forEach(([a,l])=>{l&&l!=="false"&&(t==="style"?s.set(a.trim(),l):o(a))}),s}function x(t,e){return t.props=t.props||{},e?t.tag==="templateParams"?(t.props=e,t):(Object.entries(e).forEach(([s,o])=>{if(o===null){t.props[s]=null;return}if(s==="class"||s==="style"){t.props[s]=F(s,o);return}if(W.has(s)){if(["textContent","innerHTML"].includes(s)&&typeof o=="object"){let p=e.type;if(e.type||(p="application/json"),!p?.endsWith("json")&&p!=="speculationrules")return;e.type=p,t.props.type=p,t[s]=JSON.stringify(o)}else t[s]=o;return}const a=String(o),l=s.startsWith("data-");a==="true"||a===""?t.props[s]=l?a:!0:!o&&l&&a==="false"?t.props[s]="false":o!==void 0&&(t.props[s]=o)}),t):t}function K(t,e){const s=typeof e=="object"&&typeof e!="function"?e:{[t==="script"||t==="noscript"||t==="style"?"innerHTML":"textContent"]:e},o=x({tag:t,props:{}},s);return o.key&&v.has(o.tag)&&(o.props["data-hid"]=o._h=o.key),o.tag==="script"&&typeof o.innerHTML=="object"&&(o.innerHTML=JSON.stringify(o.innerHTML),o.props.type=o.props.type||"application/json"),Array.isArray(o.props.content)?o.props.content.map(a=>({...o,props:{...o.props,content:a}})):o}function V(t,e){if(!t)return[];typeof t=="function"&&(t=t());const s=(a,l)=>{for(let p=0;p<e.length;p++)l=e[p](a,l);return l};t=s(void 0,t);const o=[];return t=H(t,s),Object.entries(t||{}).forEach(([a,l])=>{if(l!==void 0)for(const p of Array.isArray(l)?l:[l])o.push(K(a,p))}),o.flat()}const C=(t,e)=>t._w===e._w?t._p-e._p:t._w-e._w,P={base:-10,title:10},G={critical:-8,high:-1,low:2},L={meta:{"content-security-policy":-30,charset:-20,viewport:-15},link:{preconnect:20,stylesheet:60,preload:70,modulepreload:70,prefetch:90,"dns-prefetch":90,prerender:90},script:{async:30,defer:80,sync:50},style:{imported:40,sync:60}},J=/@import/,b=t=>t===""||t===!0;function N(t,e){if(typeof e.tagPriority=="number")return e.tagPriority;let s=100;const o=G[e.tagPriority]||0,a=t.resolvedOptions.disableCapoSorting?{link:{},script:{},style:{}}:L;if(e.tag in P)s=P[e.tag];else if(e.tag==="meta"){const l=e.props["http-equiv"]==="content-security-policy"?"content-security-policy":e.props.charset?"charset":e.props.name==="viewport"?"viewport":null;l&&(s=L.meta[l])}else e.tag==="link"&&e.props.rel?s=a.link[e.props.rel]:e.tag==="script"?b(e.props.async)?s=a.script.async:e.props.src&&!b(e.props.defer)&&!b(e.props.async)&&e.props.type!=="module"&&!e.props.type?.endsWith("json")?s=a.script.sync:b(e.props.defer)&&e.props.src&&!b(e.props.async)&&(s=a.script.defer):e.tag==="style"&&(s=e.innerHTML&&J.test(e.innerHTML)?a.style.imported:a.style.sync);return(s||100)+o}function E(t,e){const s=typeof e=="function"?e(t):e,o=s.key||String(t.plugins.size+1);t.plugins.get(o)||(t.plugins.set(o,s),t.hooks.addHooks(s.hooks||{}))}function B(t={}){const e=O();e.addHooks(t.hooks||{});const s=!t.document,o=new Map,a=new Map,l=new Set,p={_entryCount:1,plugins:a,dirty:!1,resolvedOptions:t,hooks:e,ssr:s,entries:o,headEntries(){return[...o.values()]},use:c=>E(p,c),push(c,m){const h={...m||{}};delete h.head;const T=h._index??p._entryCount++,g={_i:T,input:c,options:h},f={_poll(n=!1){p.dirty=!0,!n&&l.add(T),e.callHook("entries:updated",p)},dispose(){o.delete(T)&&p.invalidate()},patch(n){(!h.mode||h.mode==="server"&&s||h.mode==="client"&&!s)&&(g.input=n,o.set(T,g),f._poll())}};return f.patch(c),f},async resolveTags(){const c={tagMap:new Map,tags:[],entries:[...p.entries.values()]};for(await e.callHook("entries:resolve",c);l.size;){const f=l.values().next().value;l.delete(f);const n=o.get(f);if(n){const i={tags:V(n.input,t.propResolvers||[]).map(r=>Object.assign(r,n.options)),entry:n};await e.callHook("entries:normalize",i),n._tags=i.tags.map((r,y)=>(r._w=N(p,r),r._p=(n._i<<10)+y,r._d=k(r),r))}}let m=!1;c.entries.flatMap(f=>(f._tags||[]).map(n=>({...n,props:{...n.props}}))).sort(C).reduce((f,n)=>{const i=String(n._d||n._p);if(!f.has(i))return f.set(i,n);const r=f.get(i);if((n?.tagDuplicateStrategy||(z.has(n.tag)?"merge":null)||(n.key&&n.key===r.key?"merge":null))==="merge"){const d={...r.props};Object.entries(n.props).forEach(([u,w])=>d[u]=u==="style"?new Map([...r.props.style||new Map,...w]):u==="class"?new Set([...r.props.class||new Set,...w]):w),f.set(i,{...n,props:d})}else n._p>>10===r._p>>10&&n.tag==="meta"&&j(i)?(f.set(i,Object.assign([...Array.isArray(r)?r:[r],n],n)),m=!0):(n._w===r._w?n._p>r._p:n?._w<r?._w)&&f.set(i,n);return f},c.tagMap);const h=c.tagMap.get("title"),T=c.tagMap.get("titleTemplate");if(p._title=h?.textContent,T){const f=T?.textContent;if(p._titleTemplate=f,f){let n=typeof f=="function"?f(h?.textContent):f;typeof n=="string"&&!p.plugins.has("template-params")&&(n=n.replace("%s",h?.textContent||"")),h?n===null?c.tagMap.delete("title"):c.tagMap.set("title",{...h,textContent:n}):(T.tag="title",T.textContent=n)}}c.tags=Array.from(c.tagMap.values()),m&&(c.tags=c.tags.flat().sort(C)),await e.callHook("tags:beforeResolve",c),await e.callHook("tags:resolve",c),await e.callHook("tags:afterResolve",c);const g=[];for(const f of c.tags){const{innerHTML:n,tag:i,props:r}=f;if(R.has(i)&&!(Object.keys(r).length===0&&!f.innerHTML&&!f.textContent)&&!(i==="meta"&&!r.content&&!r["http-equiv"]&&!r.charset)){if(i==="script"&&n){if(r.type?.endsWith("json")){const y=typeof n=="string"?n:JSON.stringify(n);f.innerHTML=y.replace(/</g,"\\u003C")}else typeof n=="string"&&(f.innerHTML=n.replace(new RegExp(`</${i}`,"g"),`<\\/${i}`));f._d=k(f)}g.push(f)}}return g},invalidate(){for(const c of o.values())l.add(c._i);p.dirty=!0,e.callHook("entries:updated",p)}};return(t?.plugins||[]).forEach(c=>E(p,c)),p.hooks.callHook("init",p),t.init?.forEach(c=>c&&p.push(c)),p}async function Q(t,e={}){const s=e.document||t.resolvedOptions.document;if(!s||!t.dirty)return;const o={shouldRender:!0,tags:[]};if(await t.hooks.callHook("dom:beforeRender",o),!!o.shouldRender)return t._domUpdatePromise||(t._domUpdatePromise=new Promise(async a=>{const l=new Map,p=new Promise(n=>{t.resolveTags().then(i=>{n(i.map(r=>{const y=l.get(r._d)||0,d={tag:r,id:(y?`${r._d}:${y}`:r._d)||A(r),shouldRender:!0};return r._d&&j(r._d)&&l.set(r._d,y+1),d}))})});let c=t._dom;if(!c){c={title:s.title,elMap:new Map().set("htmlAttrs",s.documentElement).set("bodyAttrs",s.body)};for(const n of["body","head"]){const i=s[n]?.children;for(const r of i){const y=r.tagName.toLowerCase();if(!S.has(y))continue;const d=x({tag:y,props:{}},{innerHTML:r.innerHTML,...r.getAttributeNames().reduce((u,w)=>(u[w]=r.getAttribute(w),u),{})||{}});if(d.key=r.getAttribute("data-hid")||void 0,d._d=k(d)||A(d),c.elMap.has(d._d)){let u=1,w=d._d;for(;c.elMap.has(w);)w=`${d._d}:${u++}`;c.elMap.set(w,r)}else c.elMap.set(d._d,r)}}}c.pendingSideEffects={...c.sideEffects},c.sideEffects={};function m(n,i,r){const y=`${n}:${i}`;c.sideEffects[y]=r,delete c.pendingSideEffects[y]}function h({id:n,$el:i,tag:r}){const y=r.tag.endsWith("Attrs");c.elMap.set(n,i),y||(r.textContent&&r.textContent!==i.textContent&&(i.textContent=r.textContent),r.innerHTML&&r.innerHTML!==i.innerHTML&&(i.innerHTML=r.innerHTML),m(n,"el",()=>{i?.remove(),c.elMap.delete(n)}));for(const d in r.props){if(!Object.prototype.hasOwnProperty.call(r.props,d))continue;const u=r.props[d];if(d.startsWith("on")&&typeof u=="function"){const M=i?.dataset;if(M&&M[`${d}fired`]){const _=d.slice(0,-5);u.call(i,new Event(_.substring(2)))}i.getAttribute(`data-${d}`)!==""&&((r.tag==="bodyAttrs"?s.defaultView:i).addEventListener(d.substring(2),u.bind(i)),i.setAttribute(`data-${d}`,""));continue}const w=`attr:${d}`;if(d==="class"){if(!u)continue;for(const M of u)y&&m(n,`${w}:${M}`,()=>i.classList.remove(M)),!i.classList.contains(M)&&i.classList.add(M)}else if(d==="style"){if(!u)continue;for(const[M,_]of u)m(n,`${w}:${M}`,()=>{i.style.removeProperty(M)}),i.style.setProperty(M,_)}else u!==!1&&u!==null&&(i.getAttribute(d)!==u&&i.setAttribute(d,u===!0?"":String(u)),y&&m(n,w,()=>i.removeAttribute(d)))}}const T=[],g={bodyClose:void 0,bodyOpen:void 0,head:void 0},f=await p;for(const n of f){const{tag:i,shouldRender:r,id:y}=n;if(r){if(i.tag==="title"){s.title=i.textContent,m("title","",()=>s.title=c.title);continue}n.$el=n.$el||c.elMap.get(y),n.$el?h(n):S.has(i.tag)&&T.push(n)}}for(const n of T){const i=n.tag.tagPosition||"head";n.$el=s.createElement(n.tag.tag),h(n),g[i]=g[i]||s.createDocumentFragment(),g[i].appendChild(n.$el)}for(const n of f)await t.hooks.callHook("dom:renderTag",n,s,m);g.head&&s.head.appendChild(g.head),g.bodyOpen&&s.body.insertBefore(g.bodyOpen,s.body.firstChild),g.bodyClose&&s.body.appendChild(g.bodyClose);for(const n in c.pendingSideEffects)c.pendingSideEffects[n]();t._dom=c,await t.hooks.callHook("dom:rendered",{renders:f}),a()}).finally(()=>{t._domUpdatePromise=void 0,t.dirty=!1})),t._domUpdatePromise}function Y(t={}){const e=t.domOptions?.render||Q;t.document=t.document||(typeof window<"u"?document:void 0);const s=t.document?.head.querySelector('script[id="unhead:payload"]')?.innerHTML||!1;return B({...t,plugins:[...t.plugins||[],{key:"client",hooks:{"entries:updated":e}}],init:[s?JSON.parse(s):!1,...t.init||[]]})}function Z(t,e){let s=0;return()=>{const o=++s;e(()=>{s===o&&t()})}}export{Z as a,Y as c,Q as r,H as w};
