function A(t){return"key"in t}function F(t=32){let o="";const h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",v=h.length;let m=0;for(;m<t;)o+=h.charAt(Math.floor(Math.random()*v)),m+=1;return o}function k(t){const o=[];let h=null;const v=(e,n)=>(t!=null&&t.storeKeysPrefix?t?.storeKeysPrefix+"_":"")+((A(e)?e?.key:n)||n),m=e=>{var n,r;return{storage:e.storage||localStorage,serialize:((n=e?.serializer)==null?void 0:n.serialize)||JSON.stringify,deserialize:((r=e?.serializer)==null?void 0:r.deserialize)||JSON.parse}},S=()=>(!h&&o.length&&$(o[0].storageItem,o[0].store,v(o[0].storageItem,o[0].store.$id),o[0].id),setTimeout(S,500)),$=(e,n,r,i)=>{const{storage:I,serialize:y,deserialize:P}=m(e);let p=P(y(n.$state));i&&(h=i),p=Object.keys(p).reduce((s,u)=>{const b=!e.includePaths||!e.includePaths.length||e.includePaths.includes(u),a=!e.excludePaths||!e.excludePaths.length||!e.excludePaths.includes(u);return b&&a&&(s[u]=p[u]),s},{});try{const s=I.setItem(r,y(p));s instanceof Promise&&(n.$persistence.pending=!0,s.then(function(){i&&o.splice(o.findIndex(u=>i==u.id),1)}).catch(function(){}).finally(function(){i&&(h=null),n.$persistence.pending=!1}))}catch(s){t!=null&&t.debug&&console.error(s)}},x=t?.assertStorage||(e=>{const n="@@",r=e.setItem(n,"1"),i=function(){e.removeItem(n)};r instanceof Promise?r.then(i):i()});return e=>{var n,r,i,I,y,P;e.store.$persistence={pending:!1};const p=(n=t?.storageItemsDefault)!=null&&n.length?t?.storageItemsDefault:[{storage:localStorage}];let s=!1;e.options.persistence&&typeof e.options.persistence.enabled<"u"?e.options.persistence.enabled&&(s=!0):t?s=t.persistenceDefault??!0:s=!0;const u=t?.ensureAsyncStorageUpdateOrder??!0,b=a=>{const{storage:l,deserialize:g}=m(a),d=v(a,e.store.$id),c=l.getItem(d);if(c){try{c instanceof Promise?c.then(f=>{e.store.$patch(g(f))}):e.store.$patch(g(c))}catch(f){t!=null&&t.debug&&console.error(f)}$(a,e.store,d)}};if(s){const a=(I=(i=(r=e.options)==null?void 0:r.persistence)==null?void 0:i.storageItems)!=null&&I.length?(P=(y=e.options)==null?void 0:y.persistence)==null?void 0:P.storageItems:p;a.forEach((l,g)=>{var d,c;let f;try{f=x(l.storage||localStorage)}catch(z){t!=null&&t.debug&&console.warn(z)}g==0&&(((c=(d=e.options)==null?void 0:d.persistence)==null?void 0:c.beforeHydrate)||function(){})(e.store.$state),f instanceof Promise?f.then(()=>b(l)).catch(z=>{t!=null&&t.debug&&console.warn(z)}):b(l)}),e.store.$subscribe(()=>{a.forEach(l=>{var g,d,c;u&&(((g=l.storage)==null?void 0:g.getItem.constructor.name)==="AsyncFunction"||((d=l.storage)==null?void 0:d.setItem.constructor.name)==="AsyncFunction"||((c=l.storage)==null?void 0:c.removeItem.constructor.name)==="AsyncFunction")?o.push({id:F(),storageItem:l,store:e.store}):$(l,e.store,v(l,e.store.$id))})}),u&&S()}}}export{k as J};
