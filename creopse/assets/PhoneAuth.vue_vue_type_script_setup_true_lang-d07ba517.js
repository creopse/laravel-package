import{u as X,a as le,b as ie,c as ue,d as ce,P as de,g as pe,e as me,f as De,_ as ye}from"./index-b41c7da9.js";import{R as u}from"./response-error-code-87d1097e.js";import{w as Ce}from"./vue3-google-login-7712408e.js";import{b as _e,a as fe,P as ge,g as ve,N as Ue,_ as Ee,F as Fe,E as Ve,H as xe,I as He,G as Le,Q as Oe}from"./naive-ui-17a84883.js";import{d as be,p as L,as as Pe,o as O,P as Z,aO as t,Y as s,w as Be,c as j,l as H,a as v,Q as J,v as ne,F as qe}from"./vue_runtime-core-4f5fb440.js";import{u as he}from"./vue-i18n-84a05dd5.js";import{r as b,u as e,c as Ge}from"./vue_reactivity-852d8377.js";import{_ as Me}from"./VueTelInputWrapper-26bf9be6.js";import{I as ze}from"./iconify_vue-6750bec6.js";import{v as re}from"./vue_runtime-dom-c0cb2070.js";import{u as We,a as $e,b as Qe}from"./vue-recaptcha-486cc690.js";import{u as Ke}from"./vue-timer-hook-0366d26a.js";import{d as Ye}from"./pinia-5dd13ed8.js";import{i as je}from"./libphonenumber-js-f65e98d1.js";import{t as S}from"./vue_shared-7dcc3b7f.js";const va=be({__name:"GoogleAuth",setup(Ae){const{t:I,locale:$}=he(),{request:Q}=me(),{pickByTheme:a}=X(),{displayFormErrors:F}=X(),{userHasSuperAdminRole:P}=le(),{defaultPrefs:K}=ie(),R=_e(),B=fe(),V=ue(),x=ce(),p=L(()=>({type:"standard",theme:a("filled_blue","filled_black"),size:"large",text:"continue_with",shape:"rectangular",logo_alignment:"left",locale:$.value,width:300})),N=L(()=>x.getSettingValue("allowRegistration","boolean")),r=b(!1),q=async y=>{var f,C,c,G,M,z;B.start(),r.value=!0;const w=Ce(y.credential),l=await Q({url:"/auth/google",method:"post",data:{userData:w,clientId:y.clientId,credential:y.credential,allowRegistration:N.value,preferences:K.value}});if(l.failure&&l.error)switch(B.error(),(c=(C=(f=l.error)==null?void 0:f.response)==null?void 0:C.data)==null?void 0:c.errorCode){case u.AUTH_REGISTRATION_FAILED:R.error(I("registrationFailure"));break;case u.AUTH_MISSING_DATA:R.error(I("missingData"));break;case u.FORM_INVALID_DATA:F((z=(M=(G=l.error)==null?void 0:G.response)==null?void 0:M.data)==null?void 0:z.data);break;case u.AUTH_USER_DISABLED:R.error(I("disabledAccount"));break;case u.AUTH_INVALID_TOKEN:R.error(I("invalidRequest"));break;default:R.error(I("unableToLogin"))}else{B.finish();const h=l.result.data.user;h!=null&&h.profileType&&(h==null?void 0:h.profileType)===de.SUBSCRIBER?R.error(I("unableToLogin")):(V.userData=h,P()&&x.initDefaultSettings(),V.accessToken=l.result.data.accessToken,V.accessTokenDate=pe())}r.value=!1};return(y,w)=>{const l=Pe("GoogleLogin"),f=ge,C=ve;return O(),Z(C,{vertical:"",class:"text-center"},{default:t(()=>[s(f,{size:"small",show:e(r)},{default:t(()=>[(O(),Z(l,{key:e($)+"_gl_btn_"+e(a)("light","dark"),callback:q,"button-config":e(p)},null,8,["button-config"]))]),_:1},8,["show"])]),_:1})}}}),Je={class:"flex flex-col items-center"},Xe={class:"text-xs"},Ze={class:"flex flex-col items-center mt-5"},ea={class:"text-xs"},aa={key:0},ba=be({__name:"PhoneAuth",emits:["displayDialog"],setup(Ae,{emit:I}){We().scriptInjected||$e();const Q=I,{t:a}=he(),{request:F}=me(),{displayFormErrors:P}=X(),{userHasSuperAdminRole:K}=le(),{defaultPrefs:R}=ie(),B=De(),V=ce(),x=ue(),p=b(!1),N=b(!1),r=_e(),q=fe(),y=L(()=>V.getSettingValue("allowRegistration","boolean"));Be(()=>N.value,n=>{Q("displayDialog",n)});const w=Ye("phone-auth-store",()=>({loopsNumber:b(0)}))(),l=b(!1),f=b(!1),C=b(null),c=b({lastname:"",firstname:"",phone:""}),G=L(()=>({lastname:[{required:f.value,message:a("fillRequired")}],firstname:[{required:f.value,message:a("fillRequired")}],phone:[{required:!0,message:a("fillRequired")},{trigger:["input"],validator(n,o){return je(o)?new Promise((_,m)=>F({url:`/user/phone/${o}`}).then(i=>{i.success&&i.result.data&&i.result.data.firstname&&i.result.data.lastname?(f.value=!1,_()):c.value.lastname&&c.value.firstname?_():(f.value=!0,m(Error()))}).catch(()=>{f.value=!0,m(Error())})):new Error(a("invalidNumber"))}}]})),{root:M,onVerify:z}=Qe({options:{theme:B.isLightTheme?"light":"dark",size:"normal"}}),h=b();z(async n=>{h.value=n});const ee=b(null),W=b({code:""}),ke={code:[{required:!0,message:a("fillRequired")}]},U=Ke(void 0,w.loopsNumber>0),Y=()=>{const n=new Date;n.setSeconds(n.getSeconds()+120*(w.loopsNumber||1)),U.restart(n.getTime())};w.loopsNumber>0&&Y();const ae=n=>n.toString().padStart(2,"0"),oe=L(()=>ae(U.minutes.value)),se=L(()=>ae(U.seconds.value)),Te=()=>{var n,o;return l.value?(n=ee.value)==null||n.validate(async _=>{var m,i,A,g,E,D;if(!_){q.start(),p.value=!0;const d=await F({url:"/auth/phone/verify",method:"post",data:{code:W.value,...c.value}});if(d.failure&&d.error)switch(q.error(),(A=(i=(m=d.error)==null?void 0:m.response)==null?void 0:i.data)==null?void 0:A.errorCode){case u.AUTH_USER_NOT_FOUND:r.error(a("userNotFound"));break;case u.AUTH_MISSING_DATA:r.error(a("missingData"));break;case u.FORM_INVALID_DATA:P((D=(E=(g=d.error)==null?void 0:g.response)==null?void 0:E.data)==null?void 0:D.data);break;case u.AUTH_USER_DISABLED:r.error(a("disabledAccount"));break;case u.AUTH_CODE_VERIFICATION_FAILED:r.error(a("wrongCode"));break;default:r.error(a("unableToLogin"))}else{q.finish();const k=d.result.data.user;k!=null&&k.profileType&&(k==null?void 0:k.profileType)===de.SUBSCRIBER?r.error(a("unableToLogin")):(w.loopsNumber=0,x.userData=k,K()&&V.initDefaultSettings(),x.accessToken=d.result.data.accessToken,x.accessTokenDate=pe(),l.value=!1,N.value=!1)}p.value=!1}}):(o=C.value)==null||o.validate(async _=>{var m,i,A,g,E,D;if(!_&&h.value){p.value=!0;const d=await F({url:"/auth/phone",method:"post",data:{preferences:R.value,allowRegistration:y.value,...c.value}});if(d.failure&&d.error)switch((A=(i=(m=d.error)==null?void 0:m.response)==null?void 0:i.data)==null?void 0:A.errorCode){case u.AUTH_USER_NOT_FOUND:r.error(a("userNotFound"));break;case u.AUTH_MISSING_DATA:r.error(a("missingData"));break;case u.FORM_INVALID_DATA:P((D=(E=(g=d.error)==null?void 0:g.response)==null?void 0:E.data)==null?void 0:D.data);break;case u.AUTH_CODE_SENDING_FAILED:r.error(a("verificationCodeSendingFailed"));break;default:r.error(a("anErrorOccurred"))}else l.value=!0,w.loopsNumber+=1,Y();p.value=!1}}),!1},Se=async()=>{var o,_,m,i,A,g;p.value=!0;const n=await F({url:"/auth/phone",method:"post",data:{preferences:R.value,allowRegistration:y.value,...c.value}});if(n.failure&&n.error)switch((m=(_=(o=n.error)==null?void 0:o.response)==null?void 0:_.data)==null?void 0:m.errorCode){case u.AUTH_USER_NOT_FOUND:r.error(a("userNotFound"));break;case u.AUTH_MISSING_DATA:r.error(a("missingData"));break;case u.FORM_INVALID_DATA:P((g=(A=(i=n.error)==null?void 0:i.response)==null?void 0:A.data)==null?void 0:g.data);break;case u.AUTH_CODE_SENDING_FAILED:r.error(a("verificationCodeSendingFailed"));break;default:r.error(a("anErrorOccurred"))}else r.success(a("success")),w.loopsNumber+=1,Y();p.value=!1},Re=()=>{l.value?l.value=!1:N.value=!1};return(n,o)=>{const _=ze,m=Ue,i=Ee,A=ge,g=ve,E=Me,D=Fe,d=Ve,k=xe,Ne=He,we=ye,te=Le,Ie=Oe;return O(),j("section",null,[s(g,{vertical:"",class:"text-center"},{default:t(()=>[s(A,{size:"small",show:e(p)},{default:t(()=>[s(i,{block:"",type:"warning",loading:e(p),onClick:o[0]||(o[0]=T=>N.value=!0)},{icon:t(()=>[s(m,null,{default:t(()=>[s(_,{icon:"mdi:phone"})]),_:1})]),default:t(()=>[H(" "+S(e(a)("continueWithPhoneNumber")),1)]),_:1},8,["loading"])]),_:1},8,["show"])]),_:1}),s(Ie,{show:e(N),"onUpdate:show":o[5]||(o[5]=T=>Ge(N)?N.value=T:null),loading:e(p),preset:"dialog",style:{width:"450px"},bordered:!1,closable:!1,"show-icon":!1,"mask-closable":!1,title:e(a)("continueWithPhoneNumber")},{action:t(()=>[s(g,null,{default:t(()=>[s(i,{loading:e(p),onClick:Re},{default:t(()=>[H(S(e(a)("back")),1)]),_:1},8,["loading"]),s(i,{type:"primary",disabled:e(l)?!1:e(U).isRunning.value,loading:e(p),onClick:Te},{default:t(()=>[H(S(e(l)?e(a)("validate"):e(a)("verify"))+" ",1),!e(l)&&e(U).isRunning.value?(O(),j("span",aa,[o[8]||(o[8]=H("   ")),v("span",null,S(e(oe)),1),o[9]||(o[9]=v("span",null," : ",-1)),v("span",null,S(e(se)),1)])):J("",!0)]),_:1},8,["disabled","loading"])]),_:1})]),default:t(()=>[ne(s(te,{ref_key:"dataFormRef",ref:C,model:e(c),rules:e(G),"show-label":!1,"show-require-mark":!1,size:"medium",class:"mt-5"},{default:t(()=>[s(D,{label:e(a)("phoneNumber"),path:"phone"},{default:t(()=>[s(E,{modelValue:e(c).phone,"onUpdate:modelValue":o[1]||(o[1]=T=>e(c).phone=T)},null,8,["modelValue"])]),_:1},8,["label"]),s(we,{appear:""},{default:t(()=>[e(f)?(O(),Z(Ne,{key:0,"x-gap":"12",span:24},{default:t(()=>[s(k,{span:12,label:e(a)("lastname"),path:"lastname"},{default:t(()=>[s(d,{value:e(c).lastname,"onUpdate:value":o[2]||(o[2]=T=>e(c).lastname=T),placeholder:e(a)("lastname"),class:"w-full"},null,8,["value","placeholder"])]),_:1},8,["label"]),s(k,{span:12,label:e(a)("firstname_s"),path:"firstname"},{default:t(()=>[s(d,{value:e(c).firstname,"onUpdate:value":o[3]||(o[3]=T=>e(c).firstname=T),placeholder:e(a)("firstname_s"),class:"w-full"},null,8,["value","placeholder"])]),_:1},8,["label"])]),_:1})):J("",!0)]),_:1}),v("div",Je,[v("div",{ref_key:"root",ref:M,class:"mb-2"},null,512),v("div",Xe,S(e(a)("phoneAuthHelp1")),1)])]),_:1},8,["model","rules"]),[[re,!e(l)]]),ne(s(te,{ref_key:"codeFormRef",ref:ee,model:e(W),rules:ke,"show-label":!1,"show-require-mark":!1,size:"medium",class:"mt-5"},{default:t(()=>[s(D,{label:e(a)("verificationCode"),path:"code"},{default:t(()=>[s(d,{value:e(W).code,"onUpdate:value":o[4]||(o[4]=T=>e(W).code=T),placeholder:e(a)("verificationCode"),class:"w-full"},null,8,["value","placeholder"])]),_:1},8,["label"]),s(i,{loading:e(p),disabled:e(U).isRunning.value,block:"",type:"primary",onClick:Se},{icon:t(()=>[s(m,null,{default:t(()=>[s(_,{icon:"mdi:sync"})]),_:1})]),default:t(()=>[H(" "+S(e(a)("resendVerificationCode"))+" ",1),e(U).isRunning.value?(O(),j(qe,{key:0},[o[6]||(o[6]=H("   ")),v("span",null,S(e(oe)),1),o[7]||(o[7]=v("span",null," : ",-1)),v("span",null,S(e(se)),1)],64)):J("",!0)]),_:1},8,["loading","disabled"]),v("div",Ze,[v("div",ea,S(e(a)("phoneAuthHelp2")),1)])]),_:1},8,["model"]),[[re,e(l)]])]),_:1},8,["show","loading","title"])])}}});export{va as _,ba as a};
