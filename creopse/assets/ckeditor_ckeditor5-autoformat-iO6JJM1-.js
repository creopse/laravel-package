import{P}from"./ckeditor_ckeditor5-core-CWAtyu9P.js";import{D as y}from"./ckeditor_ckeditor5-typing-uZoA9pnq.js";import{M as B,a as S}from"./ckeditor_ckeditor5-engine-BHV-Rp_a.js";import{f as q}from"./ckeditor_ckeditor5-utils-DZhn28Eg.js";/**
 * @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
 */function m(o,t,e,n){let c,s=null;typeof n=="function"?c=n:(s=o.commands.get(n),c=()=>{o.execute(n)}),o.model.document.on("change:data",(g,l)=>{if(s&&!s.isEnabled||!t.isEnabled)return;const r=q(o.model.document.selection.getRanges());if(!r.isCollapsed||l.isUndo||!l.isLocal)return;const h=Array.from(o.model.document.differ.getChanges()),a=h[0];if(h.length!=1||a.type!=="insert"||a.name!="$text"||a.length!=1)return;const i=a.position.parent;if(i.is("element","codeBlock")||i.is("element","listItem")&&typeof n!="function"&&!["numberedList","bulletedList","todoList"].includes(n)||s&&s.value===!0)return;const u=i.getChild(0),A=o.model.createRangeOn(u);if(!A.containsRange(r)&&!r.end.isEqual(A.end))return;const p=e.exec(u.data.substr(0,r.end.offset));p&&o.model.enqueueChange(d=>{const f=o.model.document.selection,L=d.createPositionAt(i,0),$=d.createPositionAt(i,p[0].length),k=new B(L,$);if(c({match:p})!==!1){const x=Array.from(f.getAttributes());d.remove(k);const C=f.getFirstRange(),v=d.createRangeIn(i);i.isEmpty&&!v.isEqual(C)&&!v.containsRange(C,!0)&&d.remove(i),F(d,f,x)}k.detach(),o.model.enqueueChange(()=>{o.plugins.get("Delete").requestUndoOnBackspace()})})})}function F(o,t,e){const n=o.model.schema,c=t.getFirstPosition();let s=new S(c);n.checkChild(s,"$text")&&(s=s.push("$text"));for(const[g,l]of e)n.checkAttribute(s,g)&&o.setSelectionAttribute(g,l)}/**
 * @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
 */function b(o,t,e,n){let c,s;e instanceof RegExp?c=e:s=e,s=s||(g=>{let l;const r=[],h=[];for(;(l=c.exec(g))!==null&&!(l&&l.length<4);){let{index:a,"1":i,"2":u,"3":A}=l;const p=i+u+A;a+=l[0].length-p.length;const d=[a,a+i.length],f=[a+i.length+u.length,a+i.length+u.length+A.length];r.push(d),r.push(f),h.push([a+i.length,a+i.length+u.length])}return{remove:r,format:h}}),o.model.document.on("change:data",(g,l)=>{if(l.isUndo||!l.isLocal||!t.isEnabled)return;const r=o.model,h=r.document.selection;if(!h.isCollapsed)return;const a=Array.from(r.document.differ.getChanges()),i=a[0];if(a.length!=1||i.type!=="insert"||i.name!="$text"||i.length!=1)return;const u=h.focus,A=u.parent,{text:p,range:d}=I(r.createRange(r.createPositionAt(A,0),u),r),f=s(p),L=R(d.start,f.format,r),$=R(d.start,f.remove,r);L.length&&$.length&&r.enqueueChange(k=>{if(n(k,L)!==!1){for(const x of $.reverse())k.remove(x);r.enqueueChange(()=>{o.plugins.get("Delete").requestUndoOnBackspace()})}})})}function R(o,t,e){return t.filter(n=>n[0]!==void 0&&n[1]!==void 0).map(n=>e.createRange(o.getShiftedBy(n[0]),o.getShiftedBy(n[1])))}function I(o,t){let e=o.start;return{text:Array.from(o.getItems()).reduce((c,s)=>!(s.is("$text")||s.is("$textProxy"))||s.getAttribute("code")?(e=t.createPositionAfter(s),""):c+s.data,""),range:t.createRange(e,o.end)}}class Q extends P{static get requires(){return[y]}static get pluginName(){return"Autoformat"}static get isOfficialPlugin(){return!0}afterInit(){const t=this.editor,e=this.editor.t;this._addListAutoformats(),this._addBasicStylesAutoformats(),this._addHeadingAutoformats(),this._addBlockQuoteAutoformats(),this._addCodeBlockAutoformats(),this._addHorizontalLineAutoformats(),t.accessibility.addKeystrokeInfos({keystrokes:[{label:e("Revert autoformatting action"),keystroke:"Backspace"}]})}_addListAutoformats(){const t=this.editor.commands;t.get("bulletedList")&&m(this.editor,this,/^[*-]\s$/,"bulletedList"),t.get("numberedList")&&m(this.editor,this,/^1[.|)]\s$/,"numberedList"),t.get("todoList")&&m(this.editor,this,/^\[\s?\]\s$/,"todoList"),t.get("checkTodoList")&&m(this.editor,this,/^\[\s?x\s?\]\s$/,()=>{this.editor.execute("todoList"),this.editor.execute("checkTodoList")})}_addBasicStylesAutoformats(){const t=this.editor.commands;if(t.get("bold")){const e=_(this.editor,"bold");b(this.editor,this,/(?:^|\s)(\*\*)([^*]+)(\*\*)$/g,e),b(this.editor,this,/(?:^|\s)(__)([^_]+)(__)$/g,e)}if(t.get("italic")){const e=_(this.editor,"italic");b(this.editor,this,/(?:^|\s)(\*)([^*_]+)(\*)$/g,e),b(this.editor,this,/(?:^|\s)(_)([^_]+)(_)$/g,e)}if(t.get("code")){const e=_(this.editor,"code");b(this.editor,this,/(`)([^`]+)(`)$/g,e)}if(t.get("strikethrough")){const e=_(this.editor,"strikethrough");b(this.editor,this,/(~~)([^~]+)(~~)$/g,e)}}_addHeadingAutoformats(){const t=this.editor.commands.get("heading");t&&t.modelElements.filter(e=>e.match(/^heading[1-6]$/)).forEach(e=>{const n=e[7],c=new RegExp(`^(#{${n}})\\s$`);m(this.editor,this,c,()=>{if(!t.isEnabled||t.value===e)return!1;this.editor.execute("heading",{value:e})})})}_addBlockQuoteAutoformats(){this.editor.commands.get("blockQuote")&&m(this.editor,this,/^>\s$/,"blockQuote")}_addCodeBlockAutoformats(){const t=this.editor,e=t.model.document.selection;t.commands.get("codeBlock")&&m(t,this,/^```$/,()=>{if(e.getFirstPosition().parent.is("element","listItem"))return!1;this.editor.execute("codeBlock",{usePreviousLanguageChoice:!0})})}_addHorizontalLineAutoformats(){this.editor.commands.get("horizontalLine")&&m(this.editor,this,/^---$/,"horizontalLine")}}function _(o,t){return(e,n)=>{if(!o.commands.get(t).isEnabled)return!1;const s=o.model.schema.getValidRanges(n,t);for(const g of s)e.setAttribute(t,!0,g);e.removeSelectionAttribute(t)}}export{Q as A};
